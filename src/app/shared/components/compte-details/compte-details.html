<div class="p-6 bg-gray-50 min-h-screen" role="main" aria-labelledby="page-title">
  <div class="max-w-6xl mx-auto">

    <!-- Loading -->
    <ng-container *ngIf="isLoading && !compte; else loaded">
      <div hlmCard class="bg-white rounded-lg p-12">
        <div class="text-center text-gray-500">
          <lucide-icon name="loader-2" class="animate-spin mx-auto mb-3" size="32"></lucide-icon>
          <p>Chargement du compte...</p>
        </div>
      </div>
    </ng-container>

    <!-- Loaded / Content -->
    <ng-template #loaded>
      <ng-container *ngIf="compte; else notFound">

        <!-- Header -->
        <div hlmCard class="bg-white rounded-lg p-6 mb-6">
          <div class="flex items-center justify-between mb-2">
            <div class="min-w-0">
              <h2 id="page-title" class="text-2xl font-bold text-gray-900 truncate">Détails du compte</h2>
              <p class="text-sm text-gray-500 mt-1 truncate">Informations complètes de votre compte bancaire</p>
            </div>

            <div class="flex items-center gap-3">
              <!-- Status badge (Spartan hlmBadge) -->
              <span hlmBadge
                    [attr.aria-label]="isSuspended() ? 'Compte suspendu' : 'Compte actif'"
                    [class]="isSuspended() ? 'bg-red-100 text-red-700 border-red-200' : 'bg-emerald-100 text-emerald-700 border-emerald-200'"
                    class="px-3 py-1 rounded-full text-xs uppercase tracking-wider font-bold"
                    role="status">
                {{ isSuspended() ? 'Suspendu' : 'Actif' }}
              </span>

              <!-- Actions -->
              <div class="flex items-center gap-2">
                <button hlmBtn class="btn-emerald inline-flex items-center gap-2" [disabled]="!compte || isSaving"
                        aria-label="Nouvelle transaction">
                  <lucide-icon name="plus" size="14" aria-hidden="true"></lucide-icon>
                  Nouvelle transaction
                </button>

                <button hlmBtn variant="outline" size="sm"
                        (click)="toggleEdit()"
                        [attr.aria-pressed]="editMode"
                        [disabled]="!compte || isSaving"
                        class="inline-flex items-center gap-2 border-gray-300 text-gray-700">
                  <lucide-icon [name]="editMode ? 'x' : 'pencil'" size="14" aria-hidden="true"></lucide-icon>
                  <span class="hidden md:inline">{{ editMode ? 'Annuler' : 'Éditer' }}</span>
                </button>

                <button hlmBtn variant="destructive" size="sm"
                        (click)="confirmAndDelete()"
                        [disabled]="!compte || isSaving"
                        class="inline-flex items-center gap-2">
                  <lucide-icon name="trash-2" size="14" aria-hidden="true"></lucide-icon>
                  <span class="hidden md:inline">Supprimer</span>
                </button>
              </div>
            </div>
          </div>
        </div>


        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

          <div class="lg:col-span-1">
            <div hlmCard class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg p-6 text-white">
              <p class="text-emerald-100 mb-1 font-medium text-sm">Solde actuel</p>
              <p class="text-3xl font-bold">
                {{ formatMontant(compte?.solde) }} <span class="text-lg font-normal">FCFA</span>
              </p>
              <p class="text-xs mt-2 opacity-75">Mise à jour: {{ formatDate(compte?.dateCreation) }}</p>
            </div>
          </div>

          <!-- Informations principales -->
          <div class="lg:col-span-2">
            <div hlmCard class="bg-white rounded-lg p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <lucide-icon name="info" size="18" class="text-emerald-600"></lucide-icon>
                Informations du compte
              </h3>

              <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <dt class="text-xs text-gray-500 uppercase tracking-wider">Type de compte</dt>
                  <dd class="mt-2 flex items-center gap-2">
                    <lucide-icon [name]="getTypeCompteIcon(compte?.typeCompte)" size="18"
                                 class="text-emerald-600"></lucide-icon>
                    <span class="font-semibold text-gray-900">{{ getTypeCompteLabel(compte?.typeCompte || '') }}</span>
                  </dd>
                </div>

                <div>
                  <dt class="text-xs text-gray-500 uppercase tracking-wider">Numéro IBAN</dt>
                  <dd class="mt-2 font-mono text-gray-900 break-all">{{ compte?.numero || '—' }}</dd>
                </div>

                <div>
                  <dt class="text-xs text-gray-500 uppercase tracking-wider">Libellé du compte</dt>
                  <dd class="mt-2 text-gray-900">{{ compte?.libelle || 'Non défini' }}</dd>
                </div>

                <div>
                  <dt class="text-xs text-gray-500 uppercase tracking-wider">Date de création</dt>
                  <dd class="mt-2 text-gray-900">{{ formatDate(compte?.dateCreation) || '—' }}</dd>
                </div>

                <div class="md:col-span-2">
                  <dt class="text-xs text-gray-500 uppercase tracking-wider">Propriétaire</dt>
                  <dd class="mt-2">
                    <p class="font-semibold text-gray-900">
                      {{ compte?.proprietaire?.prenom || '—' }} {{ compte?.proprietaire?.nom || '' }}
                    </p>
                    <p class="text-sm text-gray-500">{{ compte?.proprietaire?.email || '—' }}</p>
                    <p class="text-xs text-gray-400 mt-1">Identifiant: <span
                      class="font-mono">{{ compte?.proprietaire?.identifiant || '—' }}</span></p>
                  </dd>
                </div>
              </dl>
            </div>
          </div>
        </div>


        <div hlmCard class="bg-white rounded-lg p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <lucide-icon name="settings" size="18" class="text-emerald-600"></lucide-icon>
              Gérer le compte
            </h3>
            <div class="text-sm text-gray-500">
              <span *ngIf="!editMode">Mode lecture</span>
              <span *ngIf="editMode" class="text-emerald-600 font-medium">Mode édition</span>
            </div>
          </div>

          <form *ngIf="editMode && compte" [formGroup]="form" class="space-y-4" (ngSubmit)="saveChanges()">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label hlmLabel class="text-sm font-medium text-gray-700">Type de compte</label>
                <brn-select formControlName="typeCompte" class="w-full" [disabled]="!compte">
                  <hlm-select-trigger class="w-full border border-gray-200 rounded-md">
                    <hlm-select-value/>
                  </hlm-select-trigger>
                  <hlm-select-content>
                    <hlm-option value="COURANT">Compte Courant</hlm-option>
                    <hlm-option value="EPARGNE">Compte Épargne</hlm-option>
                    <hlm-option value="PROFESSIONNEL">Compte Business</hlm-option>
                  </hlm-select-content>
                </brn-select>
              </div>

              <div>
                <label hlmLabel class="text-sm font-medium text-gray-700">Libellé</label>
                <input hlmInput type="text" formControlName="libelle" placeholder="Ex: Mon compte principal"
                       [disabled]="   !compte"
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
              </div>
            </div>

            <div class="flex items-center gap-3 pt-2">
              <button hlmBtn type="submit"
                      class="bg-emerald-600 hover:bg-emerald-700 text-white inline-flex items-center gap-2"
                      [disabled]="!compte || isSaving || form.invalid">
                <lucide-icon name="check" size="14" class="mr-1"></lucide-icon>
                <span *ngIf="!isSaving">Enregistrer</span>
                <span *ngIf="isSaving">Enregistrement...</span>
              </button>

              <button hlmBtn variant="outline" type="button" (click)="toggleEdit()" [disabled]="isSaving || !compte"
                      class="border-gray-300 text-gray-700">
                Annuler
              </button>

              <div *ngIf="saveMessage" class="ml-4 text-sm"
                   [ngClass]="saveMessage.includes('Erreur') ? 'text-red-600' : 'text-emerald-600'">
                {{ saveMessage }}
              </div>
            </div>
          </form>

          <div *ngIf="!editMode || !compte" class="text-sm text-gray-500">
            <p *ngIf="!compte">Aucun compte sélectionné. Revenez à la liste des comptes.</p>
            <p *ngIf="!editMode && compte">Cliquez sur <strong>Éditer</strong> pour modifier les informations du compte.
            </p>
          </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div hlmCard class="p-4 bg-white rounded-lg">
            <p class="text-sm text-gray-500">Total comptes</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">3</p>
          </div>
          <div hlmCard class="p-4 bg-white rounded-lg">
            <p class="text-sm text-gray-500">Solde total</p>
            <p class="text-2xl font-bold text-emerald-600 mt-2">6 964 987 FCFA</p>
          </div>
          <div hlmCard class="p-4 bg-white rounded-lg">
            <p class="text-sm text-gray-500">Solde moyen</p>
            <p class="text-2xl font-bold text-emerald-600 mt-2">2 321 662 FCFA</p>
          </div>
        </div>

        <!-- Actions finales -->
        <div class="flex justify-between items-center gap-3 bg-white rounded-lg p-6">
          <button hlmBtn variant="outline" (click)="goBack()" class="border-gray-300 text-gray-700 hover:bg-gray-50">
            <lucide-icon name="arrow-left" size="16" class="mr-1"></lucide-icon>
            Retour
          </button>
          <button hlmBtn class="bg-emerald-600 hover:bg-emerald-700 text-white" [disabled]="!compte">
            <lucide-icon name="arrow-right-left" size="16" class="mr-1"></lucide-icon>
            Nouvelle transaction
          </button>
        </div>

      </ng-container>

      <!-- Not found -->
      <ng-template #notFound>
        <div hlmCard class="bg-white rounded-lg p-12 text-center">
          <lucide-icon name="alert-circle" size="48" class="mx-auto mb-4 text-red-500"></lucide-icon>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">Compte introuvable</h3>
          <p class="mb-6 text-gray-500">Le compte que vous recherchez n'existe pas ou a été supprimé.</p>
          <button hlmBtn class="bg-emerald-600 hover:bg-emerald-700 text-white" (click)="goBack()">Retour à la liste
          </button>
        </div>
      </ng-template>
    </ng-template>

    <!-- Global error -->
    <div *ngIf="errorMessage && !isLoading"
         class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mt-4 flex items-center gap-2">
      <lucide-icon name="alert-circle" size="16"></lucide-icon>
      {{ errorMessage }}
    </div>

  </div>
</div>
